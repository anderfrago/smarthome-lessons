<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smarthome Control</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        h1, h2 { color: #1c1e21; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .control-section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid #ddd; }
        .control-section:last-child { border-bottom: none; }
        .control-section h2 { margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .btn { padding: 12px 18px; font-size: 16px; font-weight: bold; cursor: pointer; border: none; border-radius: 6px; margin: 5px; transition: background-color 0.3s, transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-on { background-color: #28a745; color: white; }
        .btn-off { background-color: #dc3545; color: white; }
        .btn-color { color: white; }
        .btn-action { background-color: #007bff; color: white; }
        #lcd-form input[type="text"] { padding: 12px; width: 70%; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
        #lcd-form .btn { width: 25%; }
        #sensor-data { background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; }
        #sensor-data p { margin: 8px 0; font-size: 16px; }
        #response-log { margin-top: 20px; background-color: #212529; color: #f8f9fa; padding: 15px; border-radius: 8px; font-family: Menlo, Monaco, Consolas, "Courier New", monospace; height: 150px; overflow-y: scroll; font-size: 14px; }
        #response-log > div { padding-bottom: 5px; border-bottom: 1px solid #495057; }
        #response-log > div:last-child { border-bottom: none; }
    </style>
</head><body>
<div class="container">
    <h1>Smarthome Control Panel</h1>

    <div class="control-section">
        <h2>LED Control</h2>
        <button class="btn btn-on" onclick="sendCommand('led on')">Turn ON</button>
        <button class="btn btn-off" onclick="sendCommand('led off')">Turn OFF</button>
    </div>

    <div class="control-section">
        <h2>RGB LED Control</h2>
        <button class="btn btn-color" style="background-color: #dc3545;" onclick="sendCommand('rgb red')">Red</button>
        <button class="btn btn-color" style="background-color: #28a745;" onclick="sendCommand('rgb green')">Green</button>
        <button class="btn btn-color" style="background-color: #007bff;" onclick="sendCommand('rgb blue')">Blue</button>
    </div>

    <div class="control-section">
        <h2>Buzzer Control</h2>
        <button class="btn btn-on" onclick="sendCommand('buzzer on')">Turn ON</button>
        <button class="btn btn-off" onclick="sendCommand('buzzer off')">Turn OFF</button>
    </div>

    <div class="control-section">
        <h2>Servo (Door) Control</h2>
        <button class="btn btn-action" onclick="sendCommand('servo open')">Open</button>
        <button class="btn btn-action" onclick="sendCommand('servo half')">Half-Open</button>
        <button class="btn btn-action" onclick="sendCommand('servo close')">Close</button>
    </div>

    <div class="control-section">
        <h2>LCD Message</h2>
        <form id="lcd-form" onsubmit="sendLcdMessage(event)">
            <input type="text" id="lcd-message" name="message" placeholder="Enter message for LCD">
            <button type="submit" class="btn btn-action">Send</button>
        </form>
    </div>

    <div class="control-section">
        <h2>Sensor Status</h2>
        <button class="btn btn-action" onclick="updateSensorData()" style="margin-bottom: 15px;">Refresh Sensor Data</button>
        <div id="sensor-data">
            <p><strong>Fire Safety:</strong> <span id="fire_safety">N/A</span></p>
            <p><strong>Noise Status:</strong> <span id="noise_status">N/A</span></p>
            <p><strong>Motion Status:</strong> <span id="motion_status">N/A</span></p>
            <p><strong>Distance:</strong> <span id="distance">N/A</span></p>
            <p><strong>Humidity:</strong> <span id="humidity">N/A</span></p>
            <p><strong>Temperature:</strong> <span id="temperature">N/A</span></p>
        </div>
    </div>

    <h2>Device Response Log</h2>
    <div id="response-log"></div>

</div>

<script>
    function logResponse(message) {
        const log = document.getElementById('response-log');
        const time = new Date().toLocaleTimeString();
        log.innerHTML += `<div>[${time}] ${message}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    function sendCommand(command) {
        logResponse(`Sending: ${command}`);
        const formData = new FormData();
        formData.append('command', command);

        fetch('/control', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            logResponse(`Received: ${data.response.join(', ')}`);
        })
        .catch(error => {
            console.error('Error:', error);
            logResponse(`<span style="color: #dc3545;">Error: Could not contact server.</span>`);
        });
    }

    function sendLcdMessage(event) {
        event.preventDefault();
        const message = document.getElementById('lcd-message').value;
        logResponse(`Sending LCD message: "${message}"`);
        const formData = new FormData();
        formData.append('command', 'lcd');
        formData.append('message', message);

        fetch('/control', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            logResponse(`Received: ${data.response.join(', ')}`);
        })
        .catch(error => {
            console.error('Error:', error);
            logResponse(`<span style="color: #dc3545;">Error: Could not contact server.</span>`);
        });
    }

    function updateSensorData() {
        logResponse('Requesting sensor data...');
        fetch('/sensors')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                logResponse(`<span style="color: #dc3545;">Error: ${data.error}</span>`);
                return;
            }
            logResponse('Sensor data updated.');
            document.getElementById('fire_safety').textContent = data.fire_safety || 'N/A';
            document.getElementById('noise_status').textContent = data.noise_status || 'N/A';
            document.getElementById('motion_status').textContent = data.motion_status || 'N/A';
            document.getElementById('distance').textContent = data.distance || 'N/A';
            document.getElementById('humidity').textContent = data.humidity || 'N/A';
            document.getElementById('temperature').textContent = data.temperature || 'N/A';
        })
        .catch(error => {
            console.error('Error:', error);
            logResponse(`<span style="color: #dc3545;">Error fetching sensor data.</span>`);
        });
    }
    
    // Initial sensor data load and periodic refresh
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(updateSensorData, 500); // Initial load after a brief delay
        setInterval(updateSensorData, 10000); // Refresh every 10 seconds
    });
</script>
</body>
</html>
